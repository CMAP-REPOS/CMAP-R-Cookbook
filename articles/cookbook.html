<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A cookbook for cmapplot • cmapplot</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="A cookbook for cmapplot">
<meta property="og:description" content="cmapplot">
<meta property="og:image" content="https://cmap-repos.github.io/cmapplot/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cmapplot</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/installation.html">Installing cmapplot on a CMAP computer</a>
    </li>
    <li>
      <a href="../articles/plots.html">Creating CMAP-themed plots</a>
    </li>
    <li>
      <a href="../articles/finalize.html">Finalizing and exporting CMAP-themed plots</a>
    </li>
    <li>
      <a href="../articles/colors.html">Applying CMAP color schemes</a>
    </li>
    <li>
      <a href="../articles/cookbook.html">A cookbook for cmapplot</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/CMAP-REPOS/cmapplot/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="cookbook_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>A cookbook for cmapplot</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/CMAP-REPOS/cmapplot/blob/master/vignettes/cookbook.Rmd"><code>vignettes/cookbook.Rmd</code></a></small>
      <div class="hidden name"><code>cookbook.Rmd</code></div>

    </div>

    
    
<p>This vignette is a showcase of cmapplot’s full capabilities by replicating as closely as possible a variety of published CMAP graphics. The sample code here can be used as a starting point for creating a number of common chart types. Before running any of this code, be sure to load the both tidyverse and cmapplot packages with <code><a href="http://tidyverse.tidyverse.org">library(tidyverse)</a></code> and <code><a href="https://cmap-repos.github.io/cmapplot">library(cmapplot)</a></code>.</p>
<div id="line-graph" class="section level2">
<h2 class="hasAnchor">
<a href="#line-graph" class="anchor"></a>Line graph</h2>
<p>Line graphs are useful for showing change over time, and are well-suited for combination with <code><a href="../reference/geom_text_lastonly.html">geom_text_lastonly()</a></code> and <code><a href="../reference/geom_recessions.html">geom_recessions()</a></code> custom geoms. This particular plot also demonstrates the utility of a few other functions from the tidyverse that are quite useful when working with <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot2::ggplot()</a></code>:</p>
<ul>
<li><p><code><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">forcats::fct_reorder()</a></code> and <code><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">forcats::fct_reorder2()</a></code> are useful to automatically order of factors within <code>mapping</code>, which establishes legend order. (See also <a href="https://r4ds.had.co.nz/factors.html#modifying-factor-order">the Factors chapter of <em>R for Data Science</em></a>.)</p></li>
<li><p>functions from the <code>scales</code> package, such as <code><a href="https://scales.r-lib.org//reference/label_percent.html">scales::percent()</a></code> and <code><a href="https://scales.r-lib.org//reference/label_percent.html">scales::label_percent()</a></code>, which reformat numbers into attractive formats.</p></li>
<li><p>ggplot2 scale functions, such as <code><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">ggplot2::scale_x_continuous()</a></code>, which allow for control over the extent and breaks of each axis.</p></li>
</ul>
<div id="example-code" class="section level4">
<h4 class="hasAnchor">
<a href="#example-code" class="anchor"></a>Example code</h4>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Get example dataset, and create a relative GRP field</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="va">peer_grp</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">area</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>indexed <span class="op">=</span> <span class="va">grp</span> <span class="op">/</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html">first</a></span><span class="op">(</span><span class="va">grp</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>


<span class="co"># Create line plot</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">df</span>,
  mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>
    x <span class="op">=</span> <span class="va">year</span>,
    y <span class="op">=</span> <span class="va">indexed</span>,
    color <span class="op">=</span> <span class="fu">fct_reorder2</span><span class="op">(</span><span class="va">area</span>, <span class="va">year</span>, <span class="va">indexed</span><span class="op">)</span>,  <span class="co"># Order legend by last `indexed` value in last `year`</span>
    label <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/label_percent.html">percent</a></span><span class="op">(</span><span class="va">indexed</span>, accuracy <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>  <span class="co"># Format labels as percents with no decimals</span>
  <span class="op">)</span>
<span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Add geoms, making sure to keep recessions under lines</span>
  <span class="fu"><a href="../reference/geom_recessions.html">geom_recessions</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="fl">0</span>, ymax <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>lineend <span class="op">=</span> <span class="st">"round"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="../reference/geom_text_lastonly.html">geom_text_lastonly</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Establish an attractive Y scale</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>
    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/label_percent.html">label_percent</a></span><span class="op">(</span>accuracy <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
    expand <span class="op">=</span> <span class="fu">expansion</span><span class="op">(</span>add <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>  <span class="co"># No padding beyond specified limits</span>
  <span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Establish an attractive X scale</span>
  <span class="fu">scale_x_continuous</span><span class="op">(</span>
    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">year</span><span class="op">)</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">year</span><span class="op">)</span>, by <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,  <span class="co"># Set breaks to every other year</span>
    expand <span class="op">=</span> <span class="fu">expansion</span><span class="op">(</span>add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1.25</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Set custom padding for L/R sides of axis </span>
  <span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Apply CMAP theme and color palette</span>
  <span class="fu"><a href="../reference/theme_cmap.html">theme_cmap</a></span><span class="op">(</span>
    overrides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>margin_panel_r <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>  <span class="co"># Shrink distance btwn gridlines ending and plotting extent</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="../reference/cmap_fill_discrete.html">cmap_color_discrete</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"legislation"</span><span class="op">)</span>
  

<span class="co"># Create final plot</span>
<span class="fu"><a href="../reference/finalize_plot.html">finalize_plot</a></span><span class="op">(</span>
  plot <span class="op">=</span> <span class="va">p</span>,
  title <span class="op">=</span> <span class="st">"Cumulative growth in real gross regional product, 2001-19"</span>,
  caption <span class="op">=</span> <span class="st">"Note: Index year 2001.
    &lt;br&gt;&lt;br&gt;
    Source: Chicago Metropolitan Agency for Planning analysis of U.S. Bureau
    of Economic Analysis and Economic Modeling Specialists International data
    (Emsi 2020.4)."</span>,
  
  <span class="co"># Tweak plot layout</span>
  height <span class="op">=</span> <span class="fl">4.5</span>,
  title_width <span class="op">=</span> <span class="fl">2.6</span>,
  overrides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    margin_plot_r <span class="op">=</span> <span class="fl">0</span>,  <span class="co"># Eliminate distance btwn plot and right side of image</span>
    margin_legend_b <span class="op">=</span> <span class="fl">25</span>  <span class="co"># Larger than usual gap between legend and plot</span>
  <span class="op">)</span>
<span class="op">)</span>
<span class="co">#&gt; Warning in finalize_plot(plot = p, title = "Cumulative growth in real gross regional product, 2001-19", : The argument `title_width` is deprecated and will be removed in a future release.</span>
<span class="co">#&gt;   Please update your code to use `sidebar_width` instead.</span></code></pre></div>
<p><img src="cookbook_files/figure-html/line-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div id="original-graphic" class="section level4">
<h4 class="hasAnchor">
<a href="#original-graphic" class="anchor"></a>Original graphic</h4>
<p><img src="https://www.dropbox.com/s/xol70o61citlpjj/Cumulative_Growth-01.png?raw=1" width="100%" style="display: block; margin: auto;"></p>
<p><a href="https://www.cmap.illinois.gov/programs/regional-economic-indicators/trends#Real_Gross_Regional_Product_2017">Source</a> (similar enough, although it hasn’t been updated here in some time.)</p>
</div>
</div>
<div id="area-plot" class="section level2">
<h2 class="hasAnchor">
<a href="#area-plot" class="anchor"></a>Area plot</h2>
<p>Area plots are useful for showing changes in composition over time. (See also: <a href="#stacked-bar-chart">Stacked bar chart</a>.)</p>
<div id="example-code-1" class="section level4">
<h4 class="hasAnchor">
<a href="#example-code-1" class="anchor"></a>Example code</h4>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Get &amp; format example dataset</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">cmapplot</span><span class="fu">::</span><span class="va"><a href="../reference/transit_ridership.html">transit_ridership</a></span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">ridership</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Remove entries with no ridership (in this case, </span>
                            <span class="co">#  values before PACE ADA is broken out in the data)</span>
  
  <span class="co"># Change system names to desired legend output</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>system <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op">(</span><span class="va">system</span>, 
                         <span class="st">"cta_bus"</span> <span class="op">=</span> <span class="st">"CTA Bus"</span>,
                         <span class="st">"cta_rail"</span> <span class="op">=</span> <span class="st">"CTA Rail"</span>,
                         <span class="st">"metra"</span> <span class="op">=</span> <span class="st">"Metra"</span>,
                         <span class="st">"pace"</span> <span class="op">=</span> <span class="st">"Pace"</span>,
                         <span class="st">"pace_ada"</span> <span class="op">=</span> <span class="st">"Pace ADA"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  
  <span class="co"># Make into factor with defined order for plotting (top to bottom)</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>system <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">system</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="st">"Pace ADA"</span>, <span class="st">"Pace"</span>, <span class="st">"Metra"</span>, <span class="st">"CTA Rail"</span>, <span class="st">"CTA Bus"</span>
  <span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Create area plot</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">df</span>, mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">ridership</span>, fill <span class="op">=</span> <span class="va">system</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Add the area plot</span>
  <span class="fu">geom_area</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Add the desired color palette</span>
  <span class="fu"><a href="../reference/cmap_fill_discrete.html">cmap_fill_discrete</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"legislation"</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Apply the CMAP theme</span>
  <span class="fu"><a href="../reference/theme_cmap.html">theme_cmap</a></span><span class="op">(</span>gridlines <span class="op">=</span> <span class="st">"hv"</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Reverse the order of the legend (optional)</span>
  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>


<span class="co"># Create final plot</span>
<span class="fu"><a href="../reference/finalize_plot.html">finalize_plot</a></span><span class="op">(</span>
  plot <span class="op">=</span> <span class="va">p</span>,
  title <span class="op">=</span> <span class="st">"Annual unlinked passenger trips on Regional Transportation Authority
    systems over time, by service board (in millions)."</span>,
  caption <span class="op">=</span> <span class="st">"Source: CMAP analysis of RTA data."</span><span class="op">)</span></code></pre></div>
<p><img src="cookbook_files/figure-html/area-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="scatterplot" class="section level2">
<h2 class="hasAnchor">
<a href="#scatterplot" class="anchor"></a>Scatterplot</h2>
<p>Scatterplots show relationships between two numeric variables, plotted on the x- and y-axes. Additionally, color and size can be used to represent additional variables.</p>
<div id="example-code-2" class="section level4">
<h4 class="hasAnchor">
<a href="#example-code-2" class="anchor"></a>Example code</h4>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Create example dataset</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  REGION <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Boston"</span>, <span class="st">"Chicago"</span>, <span class="st">"Los Angeles"</span>, <span class="st">"New York"</span>, <span class="st">"Washington, D.C."</span><span class="op">)</span>,
  TOT_POP_DIFF <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">41695</span>, <span class="op">-</span><span class="fl">114387</span>, <span class="fl">110955</span>, <span class="fl">322308</span>, <span class="fl">198931</span><span class="op">)</span>,
  LF_POP_DIFF <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">46296</span>, <span class="op">-</span><span class="fl">68524</span>, <span class="fl">113307</span>, <span class="fl">315163</span>, <span class="fl">173036</span><span class="op">)</span>,
  LF_RATE_DIFF_MAG <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5349653</span>, <span class="fl">0.684531</span>, <span class="fl">0.4036736</span>, <span class="fl">0.5853668</span>, <span class="fl">0.0386677</span><span class="op">)</span>,
  LF_RATE_DIFF_DIR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Increase"</span>, <span class="st">"Increase"</span>, <span class="st">"Increase"</span>, <span class="st">"Increase"</span>, <span class="st">"Decrease"</span><span class="op">)</span>
<span class="op">)</span>


<span class="co"># Create scatterplot</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">df</span>, mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">TOT_POP_DIFF</span>, y <span class="op">=</span> <span class="va">LF_POP_DIFF</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>

  <span class="co"># Apply CMAP theme with optional arguments</span>
  <span class="fu"><a href="../reference/theme_cmap.html">theme_cmap</a></span><span class="op">(</span>
    xlab <span class="op">=</span> <span class="st">"Change in population aged 25-54"</span>,  <span class="co"># Label x-axis</span>
    ylab <span class="op">=</span> <span class="st">"Change in size of labor force aged 25-54"</span>,  <span class="co"># Label y-axis</span>
    hline <span class="op">=</span> <span class="fl">0</span>, vline <span class="op">=</span> <span class="fl">0</span>,  <span class="co"># Add horizontal and vertical origin lines at 0</span>
    gridlines <span class="op">=</span> <span class="st">"hv"</span>  <span class="co"># Include both horizontal and vertical gridlines</span>
  <span class="op">)</span> <span class="op">+</span>

  <span class="co"># Adding points after theme_cmap() puts points in front of origin lines</span>
  <span class="fu">geom_point</span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>
    size <span class="op">=</span> <span class="va">LF_RATE_DIFF_MAG</span>,  <span class="co"># Associate point size with a variable</span>
    color <span class="op">=</span> <span class="va">LF_RATE_DIFF_DIR</span>  <span class="co"># Associate point color with a variable</span>
  <span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_text</span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">REGION</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Label each point with its name</span>

  <span class="co"># Manually adjust point size/color aesthetics and legend items</span>
  <span class="fu">scale_size</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">25</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Minimum/maximum size of points</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>
    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>`Increase` <span class="op">=</span> <span class="va">cmap_palettes</span><span class="op">$</span><span class="va">legislation</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,  <span class="co"># Modify point colors</span>
               `Decrease` <span class="op">=</span> <span class="va">cmap_palettes</span><span class="op">$</span><span class="va">legislation</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,
    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Increase"</span>, <span class="st">"Decrease"</span><span class="op">)</span>,  <span class="co"># Specify order of legend items</span>
    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Increase in labor force\nparticipation rate"</span>,  <span class="co"># Modify legend labels for each color</span>
               <span class="st">"Decrease in labor force\nparticipation rate"</span><span class="op">)</span>  <span class="co"># ("\n" inserts a line break)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">guides</span><span class="op">(</span>size <span class="op">=</span> <span class="st">"none"</span>,  <span class="co"># Omit size aesthetic from legend</span>
         color <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Increase legend point size</span>

  <span class="co"># Adjust gridlines and their labels</span>
  <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/label_number.html">label_comma</a></span><span class="op">(</span><span class="op">)</span>,  <span class="co"># Format x-axis numbers with commas</span>
                     limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">200000</span>, <span class="fl">400000</span><span class="op">)</span>,     <span class="co"># Set x-axis limits</span>
                     n.breaks <span class="op">=</span> <span class="fl">7</span>,                    <span class="co"># Set number of gridlines on x-axis</span>
                     expand <span class="op">=</span> <span class="fu">expansion</span><span class="op">(</span>mult <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># No padding beyond specified limits</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/label_number.html">label_comma</a></span><span class="op">(</span><span class="op">)</span>,  <span class="co"># Format y-axis numbers with commas</span>
                     limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">200000</span>, <span class="fl">400000</span><span class="op">)</span>,     <span class="co"># Set y-axis limits</span>
                     n.breaks <span class="op">=</span> <span class="fl">7</span>,                    <span class="co"># Set number of gridlines on y-axis</span>
                     expand <span class="op">=</span> <span class="fu">expansion</span><span class="op">(</span>mult <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># No padding beyond specified limits</span>
  <span class="fu">theme</span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>
    angle <span class="op">=</span> <span class="fl">45</span>,   <span class="co"># Set an angle for the x-axis numbers,</span>
    hjust <span class="op">=</span> <span class="fl">1</span>,    <span class="co"># a horizontal justification (between 0-1, trial &amp; error),</span>
    vjust <span class="op">=</span> <span class="fl">1</span>     <span class="co"># and a vertical justification (between 0-1, trial &amp; error).</span>
  <span class="op">)</span><span class="op">)</span>


<span class="co"># Create final plot</span>
<span class="fu"><a href="../reference/finalize_plot.html">finalize_plot</a></span><span class="op">(</span>
  plot <span class="op">=</span> <span class="va">p</span>,
  title <span class="op">=</span> <span class="st">"Changes in population, size of labor force, and labor force
    participation rate among prime working age residents (ages 25-54), Chicago
    and select Metropolitan Statistical Areas, 2006-10 to 2013-17"</span>,
  caption <span class="op">=</span> <span class="st">"Size of bubble represents the absolute value of percentage point
    change in labor force participation rate.
    &lt;br&gt;&lt;br&gt;
    Source: Chicago Metropolitan Agency for Planning analysis of American
    Community Survey data, five-year estimates, 2006-10 and 2013-17."</span>
<span class="op">)</span></code></pre></div>
<p><img src="cookbook_files/figure-html/scatter-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div id="original-graphic-1" class="section level4">
<h4 class="hasAnchor">
<a href="#original-graphic-1" class="anchor"></a>Original graphic</h4>
<p><img src="https://www.cmap.illinois.gov/documents/10180/1034772/PU20-0001_AGE_LABOR_FORCE_Change_in_size+copy.png" width="100%" style="display: block; margin: auto;"></p>
<p><a href="https://www.cmap.illinois.gov/updates/all/-/asset_publisher/UIMfSLnFfMB6/content/population-change-across-age-groups-in-the-cmap-region">Source</a></p>
</div>
</div>
<div id="highlighted-bar-chart" class="section level2">
<h2 class="hasAnchor">
<a href="#highlighted-bar-chart" class="anchor"></a>Highlighted bar chart</h2>
<p>The cmapplot package includes functionality for highlighting specified data using a distinct color. This is useful to compare Chicago against peer regions, for example.</p>
<p>This plot also utilizes <code>geom_label</code>, an alternative to <code>geom_text</code> that draws a rectangle behind each label to help it stand out from gridlines where they overlap.</p>
<div id="example-code-3" class="section level4">
<h4 class="hasAnchor">
<a href="#example-code-3" class="anchor"></a>Example code</h4>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Create example dataset</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  REGION <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Boston"</span>, <span class="st">"Chicago"</span>, <span class="st">"Los Angeles"</span>, <span class="st">"New York"</span>, <span class="st">"Washington, D.C."</span><span class="op">)</span>,
  MED_HH_INC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">77809</span>, <span class="fl">63327</span>, <span class="fl">62216</span>, <span class="fl">69211</span>, <span class="fl">93804</span><span class="op">)</span>
<span class="op">)</span>


<span class="co"># Create highlighted bar chart</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">df</span>,
            mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>
              x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">REGION</span>, <span class="op">-</span><span class="va">MED_HH_INC</span><span class="op">)</span>, <span class="co"># Order race by decreasing income</span>
              y <span class="op">=</span> <span class="va">MED_HH_INC</span>
            <span class="op">)</span><span class="op">)</span> <span class="op">+</span>

  <span class="co"># Add bars</span>
  <span class="fu">geom_col</span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">REGION</span><span class="op">)</span>,  <span class="co"># Fill must be set for a highlighted chart</span>
           width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>

  <span class="co"># Add horizontal line at specified value</span>
  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">55322</span><span class="op">)</span> <span class="op">+</span>

  <span class="co"># Label bars. `geom_label` draws a rectangle behind the label, to prevent </span>
  <span class="co"># overlap with gridlines</span>
  <span class="fu">geom_label</span><span class="op">(</span>
    mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>
      y <span class="op">=</span> <span class="va">MED_HH_INC</span> <span class="op">+</span> <span class="fl">2600</span>,  <span class="co"># Offset by trial &amp; error</span>
      label <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/label_dollar.html">label_dollar</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="va">MED_HH_INC</span><span class="op">)</span>  <span class="co"># Format labels as dollars</span>
    <span class="op">)</span>,
    hjust <span class="op">=</span> <span class="fl">.5</span>,  <span class="co"># Center label (0 = left aligned, 1 = right aligned)</span>
    label.size <span class="op">=</span> <span class="fl">0</span> <span class="co"># necessary to not draw a line around the label box</span>
  <span class="op">)</span> <span class="op">+</span>

  <span class="co"># Annotate the horizontal line</span>
  <span class="fu">annotate</span><span class="op">(</span>
    geom <span class="op">=</span> <span class="st">"text"</span>,
    x <span class="op">=</span> <span class="fl">5.6</span>, y <span class="op">=</span> <span class="fl">52822</span>, <span class="co"># Specify position of annotation (trial &amp; error)</span>
    label <span class="op">=</span> <span class="st">"U.S. Average $55,322"</span>,
    hjust <span class="op">=</span> <span class="fl">1</span> <span class="co"># Right align the text</span>
  <span class="op">)</span> <span class="op">+</span>

  <span class="co"># Wrap long labels along the x-axis</span>
  <span class="fu">scale_x_discrete</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/label_wrap.html">label_wrap</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>

  <span class="co"># Format y-axis numbers as percentages, and set axis limits</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/label_dollar.html">label_dollar</a></span><span class="op">(</span><span class="op">)</span>,
                     limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100000</span><span class="op">)</span>,
                     breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0</span>, to <span class="op">=</span> <span class="fl">100000</span>, by <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>

  <span class="co"># Apply CMAP theme and color palette</span>
  <span class="fu"><a href="../reference/theme_cmap.html">theme_cmap</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="../reference/cmap_fill_highlight.html">cmap_fill_highlight</a></span><span class="op">(</span>field <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">REGION</span>, value <span class="op">=</span> <span class="st">"Chicago"</span><span class="op">)</span> <span class="op">+</span>

  <span class="co"># Omit fill aesthetic from legend</span>
  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span>


<span class="co"># Create final plot</span>
<span class="fu"><a href="../reference/finalize_plot.html">finalize_plot</a></span><span class="op">(</span>
  plot <span class="op">=</span> <span class="va">p</span>,
  title <span class="op">=</span> <span class="st">"Median household income in select metropolitan statistical areas, 2016"</span>,
  caption <span class="op">=</span> <span class="st">"Source: Chicago Metropolitan Agency for Planning analysis of U.S.
    Census Bureau data."</span>
<span class="op">)</span></code></pre></div>
<p><img src="cookbook_files/figure-html/highlightbar-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div id="original-graphic-2" class="section level4">
<h4 class="hasAnchor">
<a href="#original-graphic-2" class="anchor"></a>Original graphic</h4>
<p><img src="https://www.cmap.illinois.gov/documents/10180/854316/MedianIncome_3.svg" width="100%" style="display: block; margin: auto;"></p>
<p><a href="https://www.cmap.illinois.gov/programs/regional-economic-indicators/trends">Source</a></p>
</div>
</div>
<div id="clustered-bar-chart" class="section level2">
<h2 class="hasAnchor">
<a href="#clustered-bar-chart" class="anchor"></a>Clustered bar chart</h2>
<p>Clustered bar charts allow for multiple variables to be graphed adjacent to one another for the same category. For example, in the chart below, we show Census self-response rates by demogrphic group, with responses from 2020 adjacent to responses from 2010 for each sub-group.</p>
<p>Note that <code>ggplot2</code> has two elements that can be used to generate bar charts: <code>geom_col()</code> and <code>geom_bar()</code>. In most cases, <code>geom_col()</code> will be correct, as it will graph the values supplied as heights on the x- or y-axis by default. <code>geom_bar()</code> can do the same, but only if the user sets <code>stat = "identity"</code>.</p>
<p>The chart below also demonstrates three other <code>ggplot2</code> tools that may be of interest: adding value labels above each of the bars; adding a value line (in this case, the regional average at 69%); and adding an annotation above that line to indicate what that line represents.</p>
<div id="example-code-4" class="section level4">
<h4 class="hasAnchor">
<a href="#example-code-4" class="anchor"></a>Example code</h4>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Create example dataset</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  RACE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"White"</span>, <span class="st">"White"</span>, <span class="st">"No majority"</span>, <span class="st">"No majority"</span>, <span class="st">"Asian"</span>, <span class="st">"Asian"</span>, <span class="st">"Hispanic"</span>, <span class="st">"Hispanic"</span>, <span class="st">"Black"</span>, <span class="st">"Black"</span><span class="op">)</span>,
  YEAR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2010"</span>, <span class="st">"2020"</span>, <span class="st">"2010"</span>, <span class="st">"2020"</span>, <span class="st">"2010"</span>, <span class="st">"2020"</span>, <span class="st">"2010"</span>, <span class="st">"2020"</span>, <span class="st">"2010"</span>, <span class="st">"2020"</span><span class="op">)</span>,
  RESPONSE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.760</span>, <span class="fl">.761</span>, <span class="fl">.670</span>, <span class="fl">.671</span>, <span class="fl">.634</span>, <span class="fl">.605</span>, <span class="fl">.625</span>, <span class="fl">.550</span>, <span class="fl">.580</span>, <span class="fl">.550</span><span class="op">)</span>
<span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>LABEL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%i%%"</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">RESPONSE</span> <span class="op">*</span> <span class="fl">100</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>


<span class="co"># Create clustered bar chart</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">df</span>,
            mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>
              x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">RACE</span>, <span class="op">-</span><span class="va">RESPONSE</span><span class="op">)</span>, <span class="co"># Order race by decreasing response rate</span>
              y <span class="op">=</span> <span class="va">RESPONSE</span>, fill <span class="op">=</span> <span class="va">YEAR</span>
            <span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Add gap between bars in same cluster</span>
  <span class="fu">geom_col</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.65</span>,  <span class="co"># Width should be less than position_dodge(width)</span>
           position <span class="op">=</span> <span class="fu">position_dodge</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Difference of 0.05 is usually sufficient</span>
  
  <span class="co"># Add horizontal dashed line at specified value</span>
  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">.69</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Add and format value labels for each bar on the graph</span>
  <span class="fu">geom_text</span><span class="op">(</span>
    mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>
      label <span class="op">=</span> <span class="va">LABEL</span>,
      y <span class="op">=</span> <span class="va">RESPONSE</span> <span class="op">+</span> <span class="fl">.025</span><span class="op">)</span>,  <span class="co"># Shift upward to eliminate overlap</span>
    position <span class="op">=</span> <span class="fu">position_dodge</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span>,  <span class="co"># Match geom_col's width</span>
    hjust <span class="op">=</span> <span class="fl">.5</span>  <span class="co"># Center label (0 = left aligned, 1 = right aligned)</span>
  <span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Annotate the dashed line</span>
  <span class="fu">annotate</span><span class="op">(</span>
    geom <span class="op">=</span> <span class="st">"text"</span>,
    x <span class="op">=</span> <span class="fl">5.6</span>, y <span class="op">=</span> <span class="fl">0.715</span>, <span class="co"># Specify position of annotation (trial &amp; error)</span>
    label <span class="op">=</span> <span class="st">"2020 Chicago region average: 69%"</span>,
    hjust <span class="op">=</span> <span class="fl">1</span>, <span class="co"># Right align the text</span>
    color <span class="op">=</span> <span class="st">"gray"</span> <span class="co"># set the color of the text (here, matched to above)</span>
  <span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Format y-axis numbers as percentages</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/label_percent.html">label_percent</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Apply CMAP theme and color palette</span>
  <span class="fu"><a href="../reference/theme_cmap.html">theme_cmap</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="../reference/cmap_fill_discrete.html">cmap_fill_discrete</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"governance"</span><span class="op">)</span>


<span class="co"># Create final plot</span>
<span class="fu"><a href="../reference/finalize_plot.html">finalize_plot</a></span><span class="op">(</span>
  plot <span class="op">=</span> <span class="va">p</span>,
  title <span class="op">=</span> <span class="st">"Average self-response rates in Chicago region census tracts by
    majority race and ethnicity"</span>,
  caption <span class="op">=</span> <span class="st">"Note: These figures are weighted averages based on tract-level
    response rates and housing unit totals. This analysis relies on data from
    the U.S. Census Bureau's American Community Survey and leverages Census
    designations of race and ethnicity. This includes the term 'Hispanic,'
    which in this context refers to residents of any race who categorized
    themselves as Hispanic. See 'About the data' below for more detail.
    &lt;br&gt;&lt;br&gt;
    Sources: CMAP analysis of U.S. Census Bureau data&lt;br&gt;
    (as of August 19, 2020)."</span>,
    <span class="co"># Note that we used two "&lt;br&gt;" tags to create a line break and empty line </span>
    <span class="co">#  between sources and notes.</span>
  title_width <span class="op">=</span> <span class="fl">2.4</span>,  <span class="co"># Manually specify title width</span>
  overrides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>margin_legend_b <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>  <span class="co"># Increase margin below legend</span>
<span class="op">)</span>
<span class="co">#&gt; Warning in finalize_plot(plot = p, title = "Average self-response rates in Chicago region census tracts by\n    majority race and ethnicity", : The argument `title_width` is deprecated and will be removed in a future release.</span>
<span class="co">#&gt;   Please update your code to use `sidebar_width` instead.</span></code></pre></div>
<p><img src="cookbook_files/figure-html/clusterbar-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div id="original-graphic-3" class="section level4">
<h4 class="hasAnchor">
<a href="#original-graphic-3" class="anchor"></a>Original graphic</h4>
<p><img src="https://www.cmap.illinois.gov/documents/10180/1173426/Census_Self-Response+_Chicago.svg" width="100%" style="display: block; margin: auto;"></p>
<p><a href="https://www.cmap.illinois.gov/updates/all/-/asset_publisher/UIMfSLnFfMB6/content/illinois-at-risk-of-a-census-undercount-especially-in-communities-of-color">Source</a></p>
</div>
</div>
<div id="stacked-bar-chart" class="section level2">
<h2 class="hasAnchor">
<a href="#stacked-bar-chart" class="anchor"></a>Stacked bar chart</h2>
<p>Stacked bar charts allow for the bars to represent multiple variables: the sub-bars represent individual components of a group, and the total bar height represents the sum of all of the group’s components.</p>
<div id="example-code-5" class="section level4">
<h4 class="hasAnchor">
<a href="#example-code-5" class="anchor"></a>Example code</h4>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Get &amp; format example dataset from ON TO 2050 indicators GitHub repository</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/CMAP-REPOS/ONTO2050-indicators/master/non-single-occupancy-modes/non-single-occupancy-modes.csv"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_longer</span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"PCT_NONSOV"</span><span class="op">)</span>,
               names_to <span class="op">=</span> <span class="st">"MODE"</span>,
               names_prefix <span class="op">=</span> <span class="st">"PCT_NONSOV_"</span>,
               values_to <span class="op">=</span> <span class="st">"PCT_NONSOV"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">MODE</span> <span class="op">!=</span> <span class="st">"TOTAL"</span>,
         <span class="va">ACTUAL_OR_TARGET</span> <span class="op">==</span> <span class="st">"Actual"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>MODE <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op">(</span><span class="va">MODE</span>,
                       <span class="st">"CARPOOL"</span> <span class="op">=</span> <span class="st">"Carpool"</span>,
                       <span class="st">"TRANSIT"</span> <span class="op">=</span> <span class="st">"Public transportation"</span>,
                       <span class="st">"BIKE"</span> <span class="op">=</span> <span class="st">"Bicycle"</span>,
                       <span class="st">"WALK"</span> <span class="op">=</span> <span class="st">"Walk"</span>,
                       <span class="st">"HOME"</span> <span class="op">=</span> <span class="st">"Work at home"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>MODE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">MODE</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="st">"Work at home"</span>, <span class="st">"Walk"</span>, <span class="st">"Bicycle"</span>, <span class="st">"Public transportation"</span>, <span class="st">"Carpool"</span>
  <span class="op">)</span><span class="op">)</span><span class="op">)</span>


<span class="co"># Create stacked bar chart</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">df</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">YEAR</span>, y <span class="op">=</span> <span class="va">PCT_NONSOV</span>, fill <span class="op">=</span> <span class="va">MODE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>

  <span class="co"># Add bars</span>
  <span class="fu">geom_col</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>

  <span class="co"># Format y-axis numbers as percentages, and set axis limits</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/label_percent.html">label_percent</a></span><span class="op">(</span>accuracy <span class="op">=</span> <span class="fl">1</span>, scale <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
                     limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">35</span><span class="op">)</span>,
                     breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0</span>, to <span class="op">=</span> <span class="fl">35</span>, by <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>

  <span class="co"># Label every bar along x-axis</span>
  <span class="fu">scale_x_continuous</span><span class="op">(</span>n.breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">YEAR</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>

  <span class="co"># Apply CMAP theme and color palette</span>
  <span class="fu"><a href="../reference/theme_cmap.html">theme_cmap</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="../reference/cmap_fill_discrete.html">cmap_fill_discrete</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"legislation"</span><span class="op">)</span>


<span class="co"># Create final plot</span>
<span class="fu"><a href="../reference/finalize_plot.html">finalize_plot</a></span><span class="op">(</span>
  plot <span class="op">=</span> <span class="va">p</span>,
  title <span class="op">=</span> <span class="st">"Percentage of trips to work via non-single occupancy vehicle
    (non-SOV) modes, 2009-2018"</span>,
  caption <span class="op">=</span> <span class="st">"Source: CMAP analysis of American Community Survey (ACS) data
    for the 7-county CMAP region, 1-year estimates.
    &lt;br&gt;&lt;br&gt;
    Note: The Kendall County portion of this data is based on ACS 5-year
    estimates, since 1-year estimates of mode share are not consistently
    available there due to its relatively small population."</span>
<span class="op">)</span></code></pre></div>
<p><img src="cookbook_files/figure-html/stackbar-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div id="original-graphic-4" class="section level4">
<h4 class="hasAnchor">
<a href="#original-graphic-4" class="anchor"></a>Original graphic</h4>
<p><img src="https://www.cmap.illinois.gov/documents/10180/911367/MOB_Percent_Trips_to_work_INDICATOR_FINAL.png" width="100%" style="display: block; margin: auto;"></p>
<p><a href="https://www.cmap.illinois.gov/2050/indicators/non-single-occupancy-modes">Source</a></p>
</div>
</div>
<div id="faceted-histograms" class="section level2">
<h2 class="hasAnchor">
<a href="#faceted-histograms" class="anchor"></a>Faceted histograms</h2>
<p>While statistics such as mean or median are useful for summarizing, they just scratch the surface of trends happening within a large, diverse dataset. Histograms are great for visualizing the distribution of a metric across a large sample. This particular example shows the distribution of tour beginnings and endings over the continuous variable of time. However, the continuous variable has already been made discrete by binning time in half-hour increments and summing the tours in each bin. In cases like this, <code>geom_col()</code> is the geom that makes the most sense. If your variable comes in a true continuous form, <code>geom_histogram()</code> is appropriate, and allows flexibility for bin sizes. If your variable is discrete/categorical and has not been summarized, <code>geom_bar()</code> is the best choice.</p>
<p>To make histograms even more interesting, split your data up by important categories and visualize them side-by-side to understand how distributions vary for different groups. <code>facet_grid()</code> is used here because comparisons are being made across the values of two discrete variables. If you want to split up your graph by only one variable, <code>facet_wrap()</code> will do.</p>
<p>Some smaller formatting choices to pay attention to:</p>
<ul>
<li><p><code><a href="https://dplyr.tidyverse.org/reference/recode.html">dplyr::recode_factor()</a></code> changes the column labels to “Departure” and “Return” for clarity. <code><a href="https://forcats.tidyverse.org/reference/fct_rev.html">forcats::fct_rev()</a></code> reverses the order in which the factors appear on the graph. Character/text variables can be converted to factors by <code><a href="https://rdrr.io/r/base/factor.html">factor()</a></code> or <code><a href="https://forcats.tidyverse.org/reference/as_factor.html">forcats::as_factor()</a></code> (which use different rules to determine the factor order).</p></li>
<li><p>Similar to graphs above which needed special formatting on their axis labels, <code><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">ggplot2::scale_x_time()</a></code> is used to manage the range, breaks, and labels of the x-axis, specifically when that axis represents time.</p></li>
<li><p><code><a href="http://lubridate.tidyverse.org/reference/hms.html">lubridate::hm()</a></code> converts strings into time period objects. Lubridate is a very useful package if you need to manage dates and times. Learn more about it in <a href="https://r4ds.had.co.nz/dates-and-times.html"><em>R for Data Science</em></a>.</p></li>
</ul>
<div id="example-code-6" class="section level4">
<h4 class="hasAnchor">
<a href="#example-code-6" class="anchor"></a>Example code</h4>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Get &amp; format example dataset from ABM validation report GitHub repository</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/CMAP-REPOS/cmap_abm_report/master/data/csv37_tours_tod.csv"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cat</span> <span class="op">!=</span> <span class="st">"all"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    purpose <span class="op">=</span> <span class="fu">fct_rev</span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode_factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">cat</span><span class="op">)</span>,
                                    `work` <span class="op">=</span> <span class="st">"Work"</span>,
                                    `school` <span class="op">=</span> <span class="st">"School"</span>,
                                    .default <span class="op">=</span> <span class="st">"Other Purposes"</span>,
                                    .ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,
    dep_arr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode_factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">subgroup</span><span class="op">)</span>,
                            `Model-Depart` <span class="op">=</span> <span class="st">"Departure"</span>,
                            `Survey-Depart` <span class="op">=</span> <span class="st">"Departure"</span>,
                            `Model-Arrive` <span class="op">=</span> <span class="st">"Return"</span>,
                            `Survey-Arrive` <span class="op">=</span> <span class="st">"Return"</span>,
                            .ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    obs_mod <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode_factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">subgroup</span><span class="op">)</span>,
                            `Model-Depart` <span class="op">=</span> <span class="st">"Modeled"</span>,
                            `Model-Arrive` <span class="op">=</span> <span class="st">"Modeled"</span>,
                            `Survey-Depart` <span class="op">=</span> <span class="st">"Observed"</span>,
                            `Survey-Arrive` <span class="op">=</span> <span class="st">"Observed"</span>,
                            .ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co"># Create faceted histograms</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">df</span>, mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">hours</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Add histogram bars</span>
  <span class="fu">geom_col</span><span class="op">(</span>  <span class="co"># Or geom_histogram() if data is not already grouped</span>
    mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">purpose</span><span class="op">)</span>  <span class="co"># Color bars by tour purpose</span>
  <span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Facet by departure/arrival and modeled/observed</span>
  <span class="fu">facet_grid</span><span class="op">(</span>rows <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">obs_mod</span><span class="op">)</span>, cols <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">dep_arr</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Apply CMAP theme and color palette</span>
  <span class="fu"><a href="../reference/theme_cmap.html">theme_cmap</a></span><span class="op">(</span>
    hline <span class="op">=</span> <span class="fl">0</span>,  <span class="co"># Add origin line at 0 for aesthetic reasons</span>
    gridlines <span class="op">=</span> <span class="st">"hv"</span>,  <span class="co"># Show horizontal and vertical gridlines</span>
    
    <span class="co"># Supply an optional "..." argument passed to ggplot2::theme()</span>
    strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>
      hjust <span class="op">=</span> <span class="fl">0.5</span>  <span class="co"># Center facet labels at axis midpoint</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="../reference/cmap_fill_discrete.html">cmap_fill_discrete</a></span><span class="op">(</span><span class="st">"friday"</span>, reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Adjust axis scales/labels</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/label_number.html">label_comma</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_x_time</span><span class="op">(</span>
    limits <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/hms.html">hm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"05:00"</span>, <span class="st">"22:00"</span><span class="op">)</span><span class="op">)</span>,
    breaks <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/hms.html">hm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"06:00"</span>, <span class="st">"09:00"</span>, <span class="st">"12:00"</span>, <span class="st">"15:00"</span>, <span class="st">"18:00"</span>, <span class="st">"21:00"</span><span class="op">)</span><span class="op">)</span>,
    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"6a"</span>, <span class="st">"9a"</span>, <span class="st">"12p"</span>, <span class="st">"3p"</span>, <span class="st">"6p"</span>, <span class="st">"9p"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Reverse legend order</span>
  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
  
<span class="co"># Create  final plot</span>
<span class="fu"><a href="../reference/finalize_plot.html">finalize_plot</a></span><span class="op">(</span>
  plot <span class="op">=</span> <span class="va">p</span>,
  title <span class="op">=</span> <span class="st">"Modeled vs. observed tour departure and return times by purpose in
    CMAP's Activity-Based Model"</span>,
  caption <span class="op">=</span> <span class="st">"Note: A tour is a chain of trips that begin at and return to the
    same location. Frequencies are given in half-hour intervals.
    &lt;br&gt;&lt;br&gt;
    Modeled source: CMAP activity-based model, 2010 scenario.
    &lt;br&gt;&lt;br&gt;
    Observed source: Travel Tracker Survey, 2007-2008."</span>
<span class="op">)</span></code></pre></div>
<p><img src="cookbook_files/figure-html/histogram-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="donut-chart-or-pie-chart" class="section level2">
<h2 class="hasAnchor">
<a href="#donut-chart-or-pie-chart" class="anchor"></a>Donut chart (or pie chart)</h2>
<p>The donut chart is a CMAP favorite for visualizing percentages of a whole. It is a variant of the pie chart, where the center has been replaced by a hole. While ggplot2 does not have a native geom for donut or pie charts, they can be constructed with a combination of <code>geom_rect()</code> and <code>coord_polar()</code>.</p>
<div id="example-code-7" class="section level4">
<h4 class="hasAnchor">
<a href="#example-code-7" class="anchor"></a>Example code</h4>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Create example dataset</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  SECTOR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Stationary energy"</span>, <span class="st">"Transportation"</span>, <span class="st">"Waste"</span><span class="op">)</span>,
  EMISSIONS <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">81.9</span>, <span class="fl">34.3</span>, <span class="fl">3.2</span><span class="op">)</span>
<span class="op">)</span>


<span class="co"># Create donut chart</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span>

  <span class="co"># Compute temporary variables needed for constructing the donut segments</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    fraction <span class="op">=</span> <span class="va">EMISSIONS</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">EMISSIONS</span><span class="op">)</span>,
    xmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">fraction</span><span class="op">)</span>,
    xmin <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">xmax</span>, default <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>

  <span class="fu">ggplot</span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">SECTOR</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>

    <span class="co"># Create donut segments as rectangles of proportional width, fixed height</span>
    <span class="fu">geom_rect</span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">xmin</span>, xmax <span class="op">=</span> <span class="va">xmax</span>,
                            ymin <span class="op">=</span> <span class="fl">2</span>, ymax <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>

    <span class="co"># Add formatted labels to center of each donut segment</span>
    <span class="fu">geom_text</span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%.0f%%"</span>, <span class="va">fraction</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span>,
                            x <span class="op">=</span> <span class="op">(</span><span class="va">xmax</span><span class="op">+</span><span class="va">xmin</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span>,
                            y <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span>,
              color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Change label color</span>

    <span class="co"># Switch from rectangular to circular grid, centered at y=0</span>
    <span class="co"># `start` (in radians) by trial and error to match original graphic</span>
    <span class="fu">coord_polar</span><span class="op">(</span>start <span class="op">=</span> <span class="fl">4.88</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Without this, result would be a pie chart</span>

    <span class="co"># Apply CMAP theme (without gridlines) and a color palette</span>
    <span class="fu"><a href="../reference/theme_cmap.html">theme_cmap</a></span><span class="op">(</span>gridline <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="../reference/cmap_fill_discrete.html">cmap_fill_discrete</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"community"</span><span class="op">)</span> <span class="op">+</span>

    <span class="co"># Turn off axis labels</span>
    <span class="fu">theme</span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>


<span class="co"># Create final plot</span>
<span class="fu"><a href="../reference/finalize_plot.html">finalize_plot</a></span><span class="op">(</span>
  plot <span class="op">=</span> <span class="va">p</span>,
  title <span class="op">=</span> <span class="st">"Regional emissions by sector, 2015"</span>,
  caption <span class="op">=</span> <span class="st">"Source: Chicago Metropolitan Agency for Planning."</span>,
  caption_valign <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span>
<span class="co">#&gt; Warning in finalize_plot(plot = p, title = "Regional emissions by sector, 2015", : The argument `caption_valign` is deprecated and will be removed in a future release.</span>
<span class="co">#&gt;   Please update your code to use `caption_align` (with a value between 0-1) instead.</span></code></pre></div>
<p><img src="cookbook_files/figure-html/donut-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div id="original-graphic-5" class="section level4">
<h4 class="hasAnchor">
<a href="#original-graphic-5" class="anchor"></a>Original graphic</h4>
<p><img src="https://www.cmap.illinois.gov/documents/10180/1132711/PU20-0000+covid+climate_regional+emissions+by+sector.jpg" width="100%" style="display: block; margin: auto;"></p>
<p><a href="https://www.cmap.illinois.gov/updates/all/-/asset_publisher/UIMfSLnFfMB6/content/cmap-estimates-show-improved-regional-air-quality-due-to-recent-transportation-shifts">Source</a></p>
</div>
</div>
<div id="race-and-ethnicity-time-series-line-graph" class="section level2">
<h2 class="hasAnchor">
<a href="#race-and-ethnicity-time-series-line-graph" class="anchor"></a>Race and ethnicity time series line graph</h2>
<p>Given CMAP’s focus on inclusive growth, many of our graphics depict data by race and ethnicity. Notably, several of the ON TO 2050 indicators track trends over time by race and ethnicity. For these cases, the cmapplot package includes a special race/ethnicity color palette that can be applied to the <code>color</code> or <code>fill</code> aesthetics of any geom.</p>
<div id="example-code-8" class="section level4">
<h4 class="hasAnchor">
<a href="#example-code-8" class="anchor"></a>Example code</h4>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Get &amp; format example dataset from ON TO 2050 indicators GitHub repository</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/CMAP-REPOS/ONTO2050-indicators/master/household-income-race-ethnicity/household-income-race-ethnicity.csv"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_longer</span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"MED_HH_INC"</span><span class="op">)</span>,
               names_to <span class="op">=</span> <span class="st">"RACE_ETH"</span>,
               names_prefix <span class="op">=</span> <span class="st">"MED_HH_INC_"</span>,
               values_to <span class="op">=</span> <span class="st">"MED_HH_INC"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>RACE_ETH <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op">(</span><span class="va">RACE_ETH</span>,
                           <span class="st">"ALL"</span> <span class="op">=</span> <span class="st">"All"</span>,
                           <span class="st">"ASIAN"</span> <span class="op">=</span> <span class="st">"Asian"</span>,
                           <span class="st">"BLACK"</span> <span class="op">=</span> <span class="st">"Black"</span>,
                           <span class="st">"HISPANIC"</span> <span class="op">=</span> <span class="st">"Hispanic"</span>,
                           <span class="st">"WHITE"</span> <span class="op">=</span> <span class="st">"White (non-Hispanic)"</span><span class="op">)</span><span class="op">)</span>


<span class="co"># Create line graph with race/ethnicity palette</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">df</span>, mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">YEAR</span>, y <span class="op">=</span> <span class="va">MED_HH_INC</span>, color <span class="op">=</span> <span class="va">RACE_ETH</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>

  <span class="co"># Add lines and label final value with dollar formatting</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="../reference/geom_text_lastonly.html">geom_text_lastonly</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/label_dollar.html">label_dollar</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="va">MED_HH_INC</span><span class="op">)</span><span class="op">)</span>,
                     add_points <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span>

  <span class="co"># Don't clip labels</span>
  <span class="fu">coord_cartesian</span><span class="op">(</span>clip <span class="op">=</span> <span class="st">"off"</span><span class="op">)</span> <span class="op">+</span>

  <span class="co"># Manually set axis limits and format y-axis labels as dollars</span>
  <span class="fu">scale_x_continuous</span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2005</span>, <span class="fl">2020</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100000</span><span class="op">)</span>,
                     breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0</span>, to <span class="op">=</span> <span class="fl">100000</span>, by <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span>,
                     labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/label_dollar.html">label_dollar</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>

  <span class="co"># Apply CMAP theme and apply race/ethnicity palette</span>
  <span class="fu"><a href="../reference/theme_cmap.html">theme_cmap</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="../reference/cmap_fill_race.html">cmap_color_race</a></span><span class="op">(</span>white <span class="op">=</span> <span class="st">"White (non-Hispanic)"</span>,
                  black <span class="op">=</span> <span class="st">"Black"</span>,
                  hispanic <span class="op">=</span> <span class="st">"Hispanic"</span>,
                  asian <span class="op">=</span> <span class="st">"Asian"</span>,
                  other <span class="op">=</span> <span class="st">"All"</span><span class="op">)</span>


<span class="co"># Create final plot</span>
<span class="fu"><a href="../reference/finalize_plot.html">finalize_plot</a></span><span class="op">(</span>
  plot <span class="op">=</span> <span class="va">p</span>,
  title <span class="op">=</span> <span class="st">"Median household income by race and ethnicity, 2006-2019, in 2016
    inflation-adjusted dollars"</span>,
  caption <span class="op">=</span> <span class="st">"Source: CMAP analysis of American Community Survey data, 1-year
    estimates."</span>
<span class="op">)</span></code></pre></div>
<p><img src="cookbook_files/figure-html/racepalette-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div id="original-graphic-6" class="section level4">
<h4 class="hasAnchor">
<a href="#original-graphic-6" class="anchor"></a>Original graphic</h4>
<p><img src="https://www.cmap.illinois.gov/documents/10180/911394/MISC_median-household-income_indicator_V1.png" width="100%" style="display: block; margin: auto;"></p>
<p><a href="https://www.cmap.illinois.gov/2050/indicators/household-income-race-ethnicity">Source</a></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Matthew Stern, Sarah Buchhorn, Daniel Comeaux, Martin Menninger, Noel Peterson, Greta Ritzenthaler.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
